CREATE OR REPLACE PROCEDURE SFDB_D_ICR_DEP_DW.ODS_DEP_DW.TEST_PER_CEID_DETAILS(
    INPUT_PAYLOAD VARIANT   -- array of objects
)
RETURNS STRING
LANGUAGE SQL
AS
$$
DECLARE
    item VARIANT;
    ceid STRING;
    user_name STRING;
    comment STRING DEFAULT 'Accepted by batch';
    client_id STRING;
    out_message STRING DEFAULT '';
BEGIN
    -- Loop over each CEID object
    FOR item IN
        SELECT VALUE
        FROM TABLE(FLATTEN(INPUT => INPUT_PAYLOAD))
    DO
        -- Extract values
        LET ceid = item.VALUE:CEID::STRING;
        LET user_name = item.VALUE:USER_NAME::STRING;
        LET comment = COALESCE(item.VALUE:COMMENT::STRING, comment);
        LET client_id = item.VALUE:CLIENT_ID::STRING;

        -- Append to output message
        out_message := out_message || 
                       'CEID: ' || ceid || 
                       ' | USER_NAME: ' || user_name || 
                       ' | COMMENT: ' || comment || 
                       ' | CLIENT_ID: ' || client_id || '\n';
    END FOR;

    RETURN out_message;
END;
$$;


CALL SFDB_D_ICR_DEP_DW.ODS_DEP_DW.TEST_PER_CEID_DETAILS(PARSE_JSON('[
    { "CEID": "CLM0001", "USER_NAME": "api_user_faaz", "COMMENT": "Accepted after review", "CLIENT_ID": "CLIENTA" },
    { "CEID": "CLM0002", "USER_NAME": "api_user_faaz", "CLIENT_ID": "CLIENTA" }
]'));
