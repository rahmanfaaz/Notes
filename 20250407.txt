CREATE OR REPLACE PROCEDURE SFDB_D_ICR_DEP_DW.ODS_DEP_DW.proc_accept_claims(
    claim_ids ARRAY,
    changed_by STRING,
    reason STRING
)
RETURNS STRING
LANGUAGE SQL
EXECUTE AS CALLER
AS '
BEGIN
    -- Insert into manager request for all matching claims
    INSERT INTO SFDB_D_ICR_DEP_DW.ODS_DEP_DW.CLAIMS_MANAGER_REQUEST
    SELECT
        CEID, CLIENT_ID, CLIENT, CLAIM_TYPE, FUND_ID, CUSTODY_ACCOUNT_NO, CUSTODIAN_NAME,
        CLAIM_DATE, CLAIM_ENG_GEN_DATE, CLAIM_ENG_GEN_TIME, AGE, AGE_SETTLEMENT, INITIATOR,
        LOCAL_AMOUNT, LOCAL_CURRENCY, AMOUNT_TOTAL_USD, ''NEW'', AGE_OF_CLAIM, LIABLE_PARTY,
        LIABLE_PARTY_SUGGESTION, LIABLE_PARTY_CONTACT, LIABLE_PARTY_ESCALATION_CONTACT,
        LATEST_COMMENTS, KINGFIELD_COMMENT, LAST_ACTIONED_DATE, NEXT_ACTION_DATE,
        ACTUAL_SETTLEMENT_DATE, REFERENCE_SOURCE, NEXT_OWNER, AMOUNT_CATEGORY_USD_EQ,
        AGE_CATEGORY, CLAIMS_ANALYST, CLAIMS_MANAGER, changed_by, EXCEPTION_CODE,
        CURRENT_TIMESTAMP, RECEIVED_MODE, CLAIM_SOURCE, ERROR_MESSAGE
    FROM SFDB_D_ICR_DEP_DW.ODS_DEP_DW.CLAIMS_MASTER
    WHERE CEID IN (
        SELECT VALUE::STRING FROM TABLE(FLATTEN(INPUT => claim_ids))
    );

    -- Delete from queue request
    DELETE FROM SFDB_D_ICR_DEP_DW.ODS_DEP_DW.CLAIMS_QUEUE_REQUEST
    WHERE CEID IN (
        SELECT VALUE::STRING FROM TABLE(FLATTEN(INPUT => claim_ids))
    );

    -- Update master record status
    UPDATE SFDB_D_ICR_DEP_DW.ODS_DEP_DW.CLAIMS_MASTER
    SET STATUS = ''ACCEPTED'', UPDATED_USER = changed_by, UPDATED_TIME = CURRENT_TIMESTAMP
    WHERE CEID IN (
        SELECT VALUE::STRING FROM TABLE(FLATTEN(INPUT => claim_ids))
    );

    -- Insert audit record
    INSERT INTO SFDB_D_ICR_DEP_DW.ODS_DEP_DW.CLAIMS_QUEUE_AUDIT
    SELECT
        UUID_STRING(), q.STATUS, ''ACCEPTED'', changed_by, CURRENT_TIMESTAMP, reason,
        q.CEID, q.CLIENT_ID, q.CLIENT, q.CLAIM_TYPE, q.FUND_ID, q.CUSTODY_ACCOUNT_NO, q.CUSTODIAN_NAME,
        q.CLAIM_DATE, q.CLAIM_ENG_GEN_DATE, q.CLAIM_ENG_GEN_TIME, q.AGE, q.INITIATOR,
        q.LOCAL_AMOUNT, q.LOCAL_CURRENCY, q.AMOUNT_TOTAL_USD, q.STATUS, q.LATEST_COMMENTS,
        q.HISTORICAL_COMMENTS, q.UPDATED_USER, q.EXCEPTION_CODE, q.UPDATED_TIME, q.RECEIVED_MODE,
        q.CLAIM_SOURCE, q.ERROR_MESSAGE
    FROM SFDB_D_ICR_DEP_DW.ODS_DEP_DW.CLAIMS_QUEUE_REQUEST q
    WHERE q.CEID IN (
        SELECT VALUE::STRING FROM TABLE(FLATTEN(INPUT => claim_ids))
    );

    RETURN ''ACCEPT action completed for '' || ARRAY_SIZE(claim_ids) || '' claims'';
END;
';
