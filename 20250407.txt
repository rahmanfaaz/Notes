#!/bin/bash
# ======================================================================================
# ğŸ¢ ENTERPRISE GIT HOOKS SETUP SCRIPT (Certified Branch = develop)
# --------------------------------------------------------------------------------------
# Creates a self-healing, auto-bootstrapping hook framework.
# Once merged into 'develop', anyone who clones the repo has hooks auto-enabled.
# ======================================================================================

set -e

echo ""
echo -e "\033[1;36mâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
echo -e "ğŸš€ Setting up Enterprise Git Hooks Enforcement Framework"
echo -e "\033[1;36mâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
echo ""

# --------------------------------------------------------------------------------------
# STEP 1 â€” Create version-controlled hook folder
# --------------------------------------------------------------------------------------
mkdir -p .githooks
echo "ğŸ“ Created .githooks directory."

# --------------------------------------------------------------------------------------
# STEP 2 â€” commit-msg (JIRA enforcement)
# --------------------------------------------------------------------------------------
cat > .githooks/commit-msg <<'EOF'
#!/bin/bash
# Enforce valid JIRA ID in every commit message
commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")
jira_pattern='(AC|TO|BUG|ICR|DEPO)-[0-9]{3,6}'

if ! echo "$commit_msg" | grep -Eq "$jira_pattern"; then
  echo -e "\033[1;31mâŒ Commit rejected:\033[0m Missing valid JIRA ID (e.g., AC-123456)"
  echo -e "\033[1;33mğŸ’¡ Example:\033[0m AC-123456 | Fixed validation issue"
  exit 1
fi
EOF

# --------------------------------------------------------------------------------------
# STEP 3 â€” verify_hooks.sh (self-healing)
# --------------------------------------------------------------------------------------
cat > .githooks/verify_hooks.sh <<'EOF'
#!/bin/bash
# Self-healing: ensures .githooks is always active
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
expected_path=".githooks"
current_path="$(git config --get core.hooksPath || echo "")"

if [ "$current_path" != "$expected_path" ]; then
  git -C "$repo_root" config core.hooksPath "$expected_path"
  chmod -R +x "$repo_root/$expected_path" >/dev/null 2>&1
  echo -e "\033[1;33mâš™ï¸  Hooks repaired: core.hooksPath reset to $expected_path\033[0m"
else
  echo -e "\033[0;32mâœ”ï¸  Hooks verified ($expected_path active)\033[0m"
fi
EOF

# --------------------------------------------------------------------------------------
# STEP 4 â€” post-checkout (auto-verify on branch switch / clone)
# --------------------------------------------------------------------------------------
cat > .githooks/post-checkout <<'EOF'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
if [ -f "$repo_root/.githooks/verify_hooks.sh" ]; then
  bash "$repo_root/.githooks/verify_hooks.sh" >/dev/null 2>&1
fi
EOF

# --------------------------------------------------------------------------------------
# STEP 5 â€” post-merge (auto-verify on merge / pull)
# --------------------------------------------------------------------------------------
cat > .githooks/post-merge <<'EOF'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
if [ -f "$repo_root/.githooks/verify_hooks.sh" ]; then
  bash "$repo_root/.githooks/verify_hooks.sh" >/dev/null 2>&1
fi
EOF

# --------------------------------------------------------------------------------------
# STEP 6 â€” pre-push (protect certified branches)
# --------------------------------------------------------------------------------------
cat > .githooks/pre-push <<'EOF'
#!/bin/bash
# Prevents direct pushes to certified branches
protected_branches="develop main master release"
current_branch=$(git rev-parse --abbrev-ref HEAD)

for b in $protected_branches; do
  if [ "$current_branch" == "$b" ]; then
    echo -e "\033[1;31mğŸš« Direct push to '$b' blocked.\033[0m"
    echo -e "\033[1;33mğŸ’¡ Use a feature branch or Pull Request.\033[0m"
    exit 1
  fi
done

echo -e "\033[1;32mâœ… Push validated for branch: $current_branch\033[0m"
EOF

# --------------------------------------------------------------------------------------
# STEP 7 â€” bootstrap.sh (auto-create .git/hooks/post-checkout)
# --------------------------------------------------------------------------------------
cat > .githooks/bootstrap.sh <<'EOF'
#!/bin/bash
# Bootstraps hooks automatically for new clones / checkouts
set -e
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
mkdir -p "$repo_root/.git/hooks"

cat > "$repo_root/.git/hooks/post-checkout" <<'INNER'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
if [ -d "$repo_root/.githooks" ]; then
  git -C "$repo_root" config core.hooksPath .githooks
  chmod -R +x "$repo_root/.githooks" >/dev/null 2>&1
  echo -e "\033[1;34mğŸª Hooks auto-activated (.githooks)\033[0m"
fi
exit 0
INNER

chmod +x "$repo_root/.git/hooks/post-checkout"
git -C "$repo_root" config core.hooksPath .githooks
chmod -R +x "$repo_root/.githooks" >/dev/null 2>&1
echo -e "\033[1;32mâœ… .githooks bootstrap complete.\033[0m"
EOF

# --------------------------------------------------------------------------------------
# STEP 8 â€” Make executable & apply immediately
# --------------------------------------------------------------------------------------
chmod -R +x .githooks
git config core.hooksPath .githooks

echo ""
echo -e "\033[1;32mâœ… Hooks activated locally for this repository.\033[0m"
echo -e "   Current hooksPath: \033[1;33m$(git config core.hooksPath)\033[0m"
echo ""

# --------------------------------------------------------------------------------------
# STEP 9 â€” Completion Summary
# --------------------------------------------------------------------------------------
echo -e "\033[1;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
echo -e "ğŸ“¦  Next Steps:"
echo -e "   1ï¸âƒ£  Commit and push .githooks/ to 'develop'"
echo -e "   2ï¸âƒ£  Hooks will self-enable automatically for all clones/checkouts"
echo -e "   3ï¸âƒ£  Direct pushes to develop/main will be blocked; all commits need JIRA IDs"
echo -e "\033[1;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
echo ""
