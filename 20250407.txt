CREATE OR REPLACE PROCEDURE SP_START_CLAIMS_UNDER_REVIEW_FTST(
    CLAIM_IDS ARRAY,
    CHANGED_BY STRING,
    LATEST_COMMENTS ARRAY,
    USER_DATE TIMESTAMP
)
RETURNS STRING
LANGUAGE SQL
AS
$$
DECLARE
  v_session_id STRING;
  v_process_name STRING;
BEGIN
  -- Generate session id
  v_session_id := UUID_STRING();
  v_process_name := 'UNDER_REVIEW_FTST';

  -- Insert CEIDs into FTST parameter control
  INSERT INTO CLAIMS_PARAMETER_CONTROL_FTST (
      claim_ids, latest_comments, changed_by, updated_time, new_status, session_id, process_name
  )
  SELECT c.value::string        AS claim_id,
         l.value::string        AS latest_comment,
         CHANGED_BY,
         USER_DATE,
         'UNDER_REVIEW',
         v_session_id,
         v_process_name
  FROM TABLE(FLATTEN(INPUT => CLAIM_IDS)) c
  JOIN TABLE(FLATTEN(INPUT => LATEST_COMMENTS)) l
    ON c.seq = l.seq;

  -- Seed FTST run control
  INSERT INTO CLAIMS_RUN_CONTROL_FTST
  SELECT v_session_id, v_process_name, 'UPD_MASTER_TASK_FTST', 'PENDING', CURRENT_TIMESTAMP, NULL, NULL
  UNION ALL
  SELECT v_session_id, v_process_name, 'UPD_QUE_REQ_TASK_FTST', 'PENDING', CURRENT_TIMESTAMP, NULL, NULL
  UNION ALL
  SELECT v_session_id, v_process_name, 'INS_QUE_AUD_TASK_FTST', 'PENDING', CURRENT_TIMESTAMP, NULL, NULL;

  -- Trigger parent task (children run AFTER)
  EXECUTE TASK CQ_UR_DML_PARENT_TASK_FTST;

  RETURN v_session_id;
END;
$$;
