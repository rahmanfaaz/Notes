- stage:
    name: Set_Latest_Chart_Version
    identifier: Set_Latest_Chart_Version
    type: CI
    spec:
      execution:
        steps:
          - step:
              name: Fetch_Latest_Chart
              identifier: Fetch_Latest_Chart
              type: ShellScript
              spec:
                shell: Bash
                onDelegate: true
                script: |
                  latest=$(helm search repo icr_dep_helm_charts_identifier --versions | grep -Eo '1\.[0-9]+' | sort -V | tail -1)
                  echo "CHART_VERSION=$latest"
                outputVariables:
                  - name: CHART_VERSION

spec:
  manifests:
    - manifest:
        identifier: icr_dep_helm_charts_identifier
        type: HelmChart
        spec:
          chartVersion: <+pipeline.stages.Set_Latest_Chart_Version.spec.execution.steps.Fetch_Latest_Chart.output.outputVariables.CHART_VERSION>
