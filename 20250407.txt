#!/bin/bash
# =================================================================================================
# ğŸ¢ ENTERPRISE GIT HOOK FRAMEWORK INITIALIZER (CERTIFIED BRANCH)
# -------------------------------------------------------------------------------------------------
# Purpose : Create a self-enforcing .githooks structure that:
#            â€¢ Validates JIRA IDs on commits and pushes
#            â€¢ Blocks rebases on protected branches
#            â€¢ Keeps hooks active after merges and checkouts
#            â€¢ Self-bootstraps for all future clones of the 'certified' branch
#            â€¢ Appends or creates README.md with Git Hook Enforcement details
#
# Usage   : Run once at repo root:    bash setup_git_hooks_certified.sh
# Commit  : Push only `.githooks` and `README.md` to 'certified' branch.
# =================================================================================================

echo ""
echo -e "\033[1;36mâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
echo -e "ğŸš€  Initializing Enterprise Git Hook Enforcement Framework"
echo -e "\033[1;36mâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
echo ""

# -----------------------------------------------------------------------------------------------
# STEP 1 â€” Create directory structure
# -----------------------------------------------------------------------------------------------
mkdir -p .githooks
echo -e "ğŸ“ Created \033[1;33m.githooks/\033[0m directory for version-controlled hooks."

# -----------------------------------------------------------------------------------------------
# STEP 2 â€” Commit Message Hook
# -----------------------------------------------------------------------------------------------
cat > .githooks/commit-msg <<'EOF'
#!/bin/bash
# -----------------------------------------------------------------------------
# Enforces presence of a valid JIRA ID in each commit message.
# -----------------------------------------------------------------------------
commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")
jira_pattern='\b(AC|TO|BUG|ICR|DEPO)-[0-9]{3,6}\b'

if echo "$commit_msg" | grep -Eq "^Merge|Bump version"; then
  exit 0
fi

if ! echo "$commit_msg" | grep -Eq "$jira_pattern"; then
  echo -e "\033[1;31mâŒ ERROR:\033[0m Commit message must include a valid JIRA ID (e.g., AC-234567)" >&2
  echo -e "\033[1;33mğŸ’¡ Example:\033[0m AC-234567 | Updated API integration" >&2
  exit 1
fi
EOF

# -----------------------------------------------------------------------------------------------
# STEP 3 â€” Post-Checkout Hook
# -----------------------------------------------------------------------------------------------
cat > .githooks/post-checkout <<'EOF'
#!/bin/bash
git config core.hooksPath .githooks
echo -e "\033[1;34mğŸª Hooks active (.githooks)\033[0m"
EOF

# -----------------------------------------------------------------------------------------------
# STEP 4 â€” Post-Merge Hook
# -----------------------------------------------------------------------------------------------
cat > .githooks/post-merge <<'EOF'
#!/bin/bash
git config core.hooksPath .githooks
echo -e "\033[1;32mğŸ” Hooks reactivated after merge.\033[0m"
EOF

# -----------------------------------------------------------------------------------------------
# STEP 5 â€” Pre-Rebase Hook
# -----------------------------------------------------------------------------------------------
cat > .githooks/pre-rebase <<'EOF'
#!/bin/bash
protected="Release_QA|Certified|main|master"
branch=$(git rev-parse --abbrev-ref HEAD)
if echo "$branch" | grep -Eq "$protected"; then
  echo -e "\033[1;31mğŸš« Rebase not allowed on protected branch: $branch\033[0m"
  exit 1
fi
EOF

# -----------------------------------------------------------------------------------------------
# STEP 6 â€” Pre-Push Hook
# -----------------------------------------------------------------------------------------------
cat > .githooks/pre-push <<'EOF'
#!/bin/bash
jira_pattern='\b(AC|TO|BUG|ICR|DEPO)-[0-9]{3,6}\b'
msg=$(git log -1 --pretty=%B)

if ! echo "$msg" | grep -Eq "$jira_pattern"; then
  echo -e "\033[1;31mâŒ Push blocked:\033[0m missing valid JIRA ID (e.g., AC-123456)"
  exit 1
fi

echo -e "\033[1;32mâœ… Push validation passed.\033[0m"
EOF

# -----------------------------------------------------------------------------------------------
# STEP 7 â€” Pre-Commit Hook
# -----------------------------------------------------------------------------------------------
cat > .githooks/pre-commit <<'EOF'
#!/bin/bash
if ! git diff --cached --name-only | grep -q .; then
  echo "âš ï¸  No staged files to commit."
  exit 0
fi
echo "ğŸ” Pre-commit check passed..."
EOF

# -----------------------------------------------------------------------------------------------
# STEP 8 â€” Bootstrap Hook
# -----------------------------------------------------------------------------------------------
cat > .githooks/bootstrap.sh <<'EOF'
#!/bin/bash
# -----------------------------------------------------------------------------
# AUTO-BOOTSTRAP: Enables .githooks automatically for every clone/checkout
# -----------------------------------------------------------------------------
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
mkdir -p "$repo_root/.git/hooks"

cat > "$repo_root/.git/hooks/post-checkout" <<'INNER'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
if [ -d "$repo_root/.githooks" ]; then
  git -C "$repo_root" config core.hooksPath .githooks
  echo -e "\033[1;34mğŸª Project hooks activated (.githooks)\033[0m"
fi
exit 0
INNER

chmod +x "$repo_root/.git/hooks/post-checkout"
git -C "$repo_root" config core.hooksPath .githooks
echo -e "\033[1;32mâœ… .githooks auto-bootstrapped successfully.\033[0m"
EOF

# -----------------------------------------------------------------------------------------------
# STEP 9 â€” Permissions & Activation
# -----------------------------------------------------------------------------------------------
chmod +x .githooks/*
git config core.hooksPath .githooks
echo -e "\n\033[1;32mâœ… All Git hooks have been generated and activated locally.\033[0m"

# -----------------------------------------------------------------------------------------------
# STEP 10 â€” Create or Always Append README.md
# -----------------------------------------------------------------------------------------------
repo_name=$(basename "$(git rev-parse --show-toplevel 2>/dev/null)")
readme_path="README.md"

echo ""
echo -e "ğŸ§¾ Updating README.md with Git Hook Enforcement Policy..."

if [ ! -f "$readme_path" ]; then
  echo -e "ğŸ“˜ No README found. Creating a new one..."
  echo "# $repo_name" > "$readme_path"
  echo "" >> "$readme_path"
fi

# Always append section (even if it already exists)
cat <<EOF >> "$readme_path"

---

## ğŸ”’ Git Hook Enforcement Policy

This repository includes an automated **Git Hook Enforcement Framework** that ensures:
- âœ… Every commit and push message contains a valid JIRA ID (e.g., AC-123456)
- ğŸš« Rebases are blocked on protected branches (Certified, main, master, etc.)
- ğŸ” Hooks are reactivated automatically after merges or checkouts

### ğŸ§  Usage Notes
1. Hooks are automatically enabled â€” no manual setup is required.  
2. Supported JIRA ID patterns: **AC-123456**, **ICR-54321**, **BUG-999**, etc.  
3. For feature branches, prefix commits with their corresponding JIRA ID.  

---

*This policy is automatically enforced when working on the **certified** branch.*
EOF

echo -e "\033[1;32mâœ… README.md has been updated or created successfully.\033[0m"

# -----------------------------------------------------------------------------------------------
# Completion Message
# -----------------------------------------------------------------------------------------------
echo ""
echo -e "\033[1;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
echo -e "ğŸ“¦  Next Steps:"
echo -e "   1ï¸âƒ£  Review hooks in \033[1;33m.githooks/\033[0m"
echo -e "   2ï¸âƒ£  Commit and push \033[1;33m.githooks/\033[0m and \033[1;33mREADME.md\033[0m to \033[1;32mcertified\033[0m branch"
echo -e "   3ï¸âƒ£  Hooks will auto-enable on clone or checkout. ğŸ’ª"
echo -e "\033[1;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
echo ""
