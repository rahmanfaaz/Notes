#!/bin/bash
# =====================================================================
# STRATIX / ICR ‚Äî AUTOMATED GIT HOOK ENFORCEMENT SETUP (FINAL)
# ---------------------------------------------------------------------
# Creates .githooks/ with all hooks + bootstrap inside it.
# Once committed and pushed to 'develop', every clone will automatically
# activate the enforcement system on first checkout.
# =====================================================================

echo "üöÄ Initializing Git hook enforcement setup..."

# ---------------------------------------------------------------------
# Create .githooks directory
# ---------------------------------------------------------------------
mkdir -p .githooks

# ---------------------------------------------------------------------
# 1Ô∏è‚É£ commit-msg ‚Äî Enforce valid JIRA ID pattern
# ---------------------------------------------------------------------
cat > .githooks/commit-msg <<'EOF'
#!/bin/bash
commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")
jira_pattern='\b(AC|TO|BUG|ICR|DEPO)-[0-9]{3,6}\b'

# Skip merge/version bump commits
if echo "$commit_msg" | grep -Eq "^Merge|Bump version"; then
  exit 0
fi

if ! echo "$commit_msg" | grep -Eq "$jira_pattern"; then
  echo -e "\033[1;31m‚ùå ERROR:\033[0m Commit message must include a valid JIRA ID (e.g., AC-234567)" >&2
  echo -e "\033[1;33müí° Example:\033[0m AC-234567 | Added Claims Validation for HSBC" >&2
  exit 1
fi
EOF

# ---------------------------------------------------------------------
# 2Ô∏è‚É£ post-checkout ‚Äî Keep hooks active after branch switch
# ---------------------------------------------------------------------
cat > .githooks/post-checkout <<'EOF'
#!/bin/bash
git config core.hooksPath .githooks
echo -e "\033[1;34mü™ù Hooks active (.githooks)\033[0m"
EOF

# ---------------------------------------------------------------------
# 3Ô∏è‚É£ post-merge ‚Äî Re-apply hooks after merge
# ---------------------------------------------------------------------
cat > .githooks/post-merge <<'EOF'
#!/bin/bash
git config core.hooksPath .githooks
echo -e "\033[1;32müîÅ Hooks reactivated after merge.\033[0m"
EOF

# ---------------------------------------------------------------------
# 4Ô∏è‚É£ pre-rebase ‚Äî Block rebases on protected branches
# ---------------------------------------------------------------------
cat > .githooks/pre-rebase <<'EOF'
#!/bin/bash
protected="Release_QA|Release_PROD|develop|master"
branch=$(git rev-parse --abbrev-ref HEAD)
if echo "$branch" | grep -Eq "$protected"; then
  echo -e "\033[1;31müö´ Rebase not allowed on protected branch: $branch\033[0m"
  exit 1
fi
EOF

# ---------------------------------------------------------------------
# 5Ô∏è‚É£ pre-push ‚Äî Validate JIRA ID before push
# ---------------------------------------------------------------------
cat > .githooks/pre-push <<'EOF'
#!/bin/bash
jira_pattern='\b(AC|TO|BUG|ICR|DEPO)-[0-9]{3,6}\b'
msg=$(git log -1 --pretty=%B)
if ! echo "$msg" | grep -Eq "$jira_pattern"; then
  echo -e "\033[1;31m‚ùå Push blocked: missing valid JIRA ID (e.g., AC-123456)\033[0m"
  exit 1
fi
echo -e "\033[1;32m‚úÖ Push validation passed.\033[0m"
EOF

# ---------------------------------------------------------------------
# 6Ô∏è‚É£ pre-commit ‚Äî Simple staged-file check
# ---------------------------------------------------------------------
cat > .githooks/pre-commit <<'EOF'
#!/bin/bash
if ! git diff --cached --name-only | grep -q .; then
  echo "‚ö†Ô∏è  No staged files to commit."
  exit 0
fi
echo "üîç Pre-commit check passed..."
EOF

# ---------------------------------------------------------------------
# 7Ô∏è‚É£ bootstrap ‚Äî Installs post-checkout activator in .git/hooks
# ---------------------------------------------------------------------
cat > .githooks/bootstrap.sh <<'EOF'
#!/bin/bash
# =====================================================================
# AUTO-BOOTSTRAP: Enables .githooks automatically for every clone/checkout
# =====================================================================
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
mkdir -p "$repo_root/.git/hooks"

# Create lightweight post-checkout activator
cat > "$repo_root/.git/hooks/post-checkout" <<'INNER'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
if [ -d "$repo_root/.githooks" ]; then
  git -C "$repo_root" config core.hooksPath .githooks
  echo -e "\033[1;34mü™ù Project hooks activated (.githooks)\033[0m"
fi
exit 0
INNER

chmod +x "$repo_root/.git/hooks/post-checkout"

# Immediately activate .githooks for this repo
git -C "$repo_root" config core.hooksPath .githooks
echo -e "\033[1;32m‚úÖ .githooks auto-bootstrapped successfully.\033[0m"
EOF

# ---------------------------------------------------------------------
# Permissions
# ---------------------------------------------------------------------
chmod +x .githooks/*

# ---------------------------------------------------------------------
# Activate hooks now
# ---------------------------------------------------------------------
git config core.hooksPath .githooks

echo -e "\n\033[1;32m‚úÖ All Git hooks installed, bootstrapped, and active from .githooks.\033[0m"
echo -e "\033[1;34mNext Steps:\033[0m"
echo -e "  ‚Ä¢ Commit and push this script + .githooks folder to 'develop'."
echo -e "  ‚Ä¢ When anyone clones 'develop', bootstrap.sh will auto-install the .git/hooks activator.\n"
