mkdir -p .githooks .git-hooks-bootstrap

# --- commit-msg ---
cat > .githooks/commit-msg <<'EOF'
#!/bin/bash
commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")
jira_pattern='\b(AC|TO|BUG|ICR|DEPO)-[0-9]{3,6}\b'

if echo "$commit_msg" | grep -Eq "^Merge|Bump version"; then
  exit 0
fi

if ! echo "$commit_msg" | grep -Eq "$jira_pattern"; then
  echo -e "\033[1;31mâŒ ERROR:\033[0m Missing valid JIRA ID (e.g., AC-123456)" >&2
  exit 1
fi
EOF

# --- post-checkout ---
cat > .githooks/post-checkout <<'EOF'
#!/bin/bash
git config core.hooksPath .githooks
echo -e "\033[1;34mðŸª Hooks active (.githooks)\033[0m"
EOF

# --- post-merge ---
cat > .githooks/post-merge <<'EOF'
#!/bin/bash
git config core.hooksPath .githooks
echo -e "\033[1;32mðŸ” Hooks reactivated after merge.\033[0m"
EOF

# --- pre-rebase ---
cat > .githooks/pre-rebase <<'EOF'
#!/bin/bash
protected="Release_QA|Release_PROD|develop|master"
branch=$(git rev-parse --abbrev-ref HEAD)
if echo "$branch" | grep -Eq "$protected"; then
  echo -e "\033[1;31mðŸš« Rebase not allowed on protected branch: $branch\033[0m"
  exit 1
fi
EOF

# --- pre-push ---
cat > .githooks/pre-push <<'EOF'
#!/bin/bash
jira_pattern='\b(AC|TO|BUG|ICR|DEPO)-[0-9]{3,6}\b'
msg=$(git log -1 --pretty=%B)
if ! echo "$msg" | grep -Eq "$jira_pattern"; then
  echo -e "\033[1;31mâŒ Push blocked: missing JIRA ID (e.g., AC-123456)\033[0m"
  exit 1
fi
EOF

# --- pre-commit ---
cat > .githooks/pre-commit <<'EOF'
#!/bin/bash
if ! git diff --cached --name-only | grep -q .; then
  echo "âš ï¸  No staged files to commit."
  exit 0
fi
echo "ðŸ” Pre-commit check passed..."
EOF

# --- bootstrap installer ---
cat > .git-hooks-bootstrap/bootstrap.sh <<'EOF'
#!/bin/bash
# AUTO-BOOTSTRAP: Enables .githooks on first checkout for every clone
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
mkdir -p "$repo_root/.git/hooks"
cat > "$repo_root/.git/hooks/post-checkout" <<'INNER'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
if [ -d "$repo_root/.githooks" ]; then
  git -C "$repo_root" config core.hooksPath .githooks
  echo -e "\033[1;34mðŸª Project hooks activated (.githooks)\033[0m"
fi
exit 0
INNER
chmod +x "$repo_root/.git/hooks/post-checkout"
git -C "$repo_root" config core.hooksPath .githooks
echo -e "\033[1;32mâœ… .githooks auto-bootstrapped successfully.\033[0m"
EOF

chmod +x .githooks/* .git-hooks-bootstrap/bootstrap.sh

# --- zip everything ---
zip -r git-hooks-package.zip .githooks .git-hooks-bootstrap >/dev/null
echo "âœ… Created git-hooks-package.zip with all files!"
