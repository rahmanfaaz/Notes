#!/bin/bash

NAMESPACE="icr-ds-dep"
POD_PATTERN="db-ingestion"

echo "Watching for new pods matching '$POD_PATTERN' in namespace '$NAMESPACE'..."

kubectl get pods -n "$NAMESPACE" --watch-only | grep --line-buffered "$POD_PATTERN" | while read -r line; do
    pod=$(echo "$line" | awk '{print $1}')
    echo "New pod detected: $pod â€” attempting to fetch logs immediately..."

    # Try fetching current logs
    echo -e "\n--- Logs from pod '$pod' ---"
    if ! kubectl logs -n "$NAMESPACE" "$pod" --timestamps; then
        echo "Primary log fetch failed, trying with --previous (pod likely exited)..."
        kubectl logs -n "$NAMESPACE" "$pod" --previous --timestamps
    fi

    break  # Exit after first match
done
