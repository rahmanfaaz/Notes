#!/bin/bash
# =====================================================================
#   ENTERPRISE GIT HOOKS ENFORCEMENT ‚Äî ONE-SHOT INSTALLER
#   Creates .githooks/, installs self-healing hooks, configures Git.
# =====================================================================

set -e

repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || {
  echo "‚ùå ERROR: Must run inside a Git repository."
  exit 1
}

echo "üìÅ Repository root: $repo_root"
hooks_dir="$repo_root/.githooks"
mkdir -p "$hooks_dir"

# =====================================================================
# 1. CREATE bootstrap.sh (self-healing auto-loader)
# =====================================================================
cat > "$hooks_dir/bootstrap.sh" << 'EOF'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
githooks_dir="$repo_root/.githooks"

# Force hooksPath
git -C "$repo_root" config core.hooksPath .githooks >/dev/null

# Restore folder if missing
if [ ! -d "$githooks_dir" ] || [ -z "$(ls -A "$githooks_dir")" ]; then
    echo "‚ö†Ô∏è  Restoring missing .githooks..."
    git restore .githooks 2>/dev/null || git checkout HEAD -- .githooks
    echo "‚úîÔ∏è  .githooks restored."
fi

chmod +x "$githooks_dir"/* 2>/dev/null

exit 0
EOF

# =====================================================================
# 2. CREATE commit-msg Hook (JIRA enforcement)
# =====================================================================
cat > "$hooks_dir/commit-msg" << 'EOF'
#!/bin/bash
commit_msg_file="$1"
commit_msg="$(cat "$commit_msg_file")"

jira_pattern="(AC|TO|ICR|BUG|DEPO)-[0-9]{3,6}"

if ! echo "$commit_msg" | grep -Eq "$jira_pattern"; then
  echo "‚ùå ERROR: Commit message must include a valid JIRA ID (e.g. AC-234567)"
  exit 1
fi

exit 0
EOF

# =====================================================================
# 3. CREATE post-checkout Hook
# =====================================================================
cat > "$hooks_dir/post-checkout" << 'EOF'
#!/bin/bash
$(git rev-parse --show-toplevel)/.githooks/bootstrap.sh
EOF

# =====================================================================
# 4. CREATE post-merge Hook
# =====================================================================
cat > "$hooks_dir/post-merge" << 'EOF'
#!/bin/bash
$(git rev-parse --show-toplevel)/.githooks/bootstrap.sh
EOF

# =====================================================================
# 5. CREATE verify_hooks.sh (validate executables)
# =====================================================================
cat > "$hooks_dir/verify_hooks.sh" << 'EOF'
#!/bin/bash
repo_root="$(git rev-parse --show-toplevel)"
chmod +x "$repo_root/.githooks"/*
EOF

# Make everything executable
chmod +x "$hooks_dir"/*

# =====================================================================
# 6. Configure Git globally for the repo
# =====================================================================
git config core.hooksPath .githooks

echo "‚úîÔ∏è Git hooksPath set to .githooks"

# =====================================================================
# 7. Update or create README.md
# =====================================================================
readme="$repo_root/README.md"

echo "" >> "$readme"
echo "## üîí Git Hooks Enforcement" >> "$readme"
echo "This repository uses an enterprise-grade Git hooks system stored in **.githooks/**." >> "$readme"
echo "Hooks are automatically installed, updated, and self-healed on every clone, checkout, merge, rebase, or pull." >> "$readme"
echo "" >> "$readme"
echo "**Rules Enforced:**" >> "$readme"
echo "- JIRA ID required in every commit message (AC-123456 format)" >> "$readme"
echo "- Hooks auto-repair if deleted" >> "$readme"
echo "- Hooks automatically activate for every developer" >> "$readme"

echo "üìù README.md updated."

# =====================================================================
# 8. Final message
# =====================================================================
echo "==================================================================="
echo "‚úîÔ∏è ENTERPRISE GITHOOKS INSTALLED SUCCESSFULLY"
echo "‚û° Commit and push .githooks to the certified Develop branch."
echo "‚û° Any clone or branch from Develop will now auto-enforce hooks."
echo "==================================================================="

exit 0
